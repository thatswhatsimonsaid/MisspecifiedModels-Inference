---
title: "Stats 572 - Simulation Study Comparison"
author: "Simon Dovan Nguyen"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    theme: lumen
    css: assets/styles.css
---

# Set Up

## Libr.
```{r message=FALSE, warning=FALSE}
library(stats)
library(tidyverse)
library(StatMatch)
library(xtable)
library(lmtest)
library(sandwich)
```

## Rm. Var.
```{r}
rm(list=ls())
dir = "/Users/simondn/Documents/Stats572/"
```

## Functions
```{r}
source(paste0(dir,"Code/AIZResults.R"))
source(paste0(dir,"Code/DiscrepancyFunction.R"))
source(paste0(dir,"Code/MonteCarloResults.R"))
source(paste0(dir,"Code/SimulationReformatResultsFunction.R"))
```

## Results
### Small Sample
```{r}
### Get Files ###
file_list = list.files(path =  paste0(dir,"Results/Linear/N50_200"),
                        pattern = "\\.rds$",
                        full.names = TRUE)
SmallSampleSimulation = list()
SmallSampleSimulation = lapply(file_list, readRDS)
rm(file_list)

### Results ###
SmallSampleSimulation = SimulationReformatResultsFunction(SmallSampleSimulation)
SmallSampleSEMedianList = SmallSampleSimulation$SimSEMedianList
# SmallSampleMonteCarloResults = MonteCarloResults(SmallSampleSimulation, 5)
SmallSampleRunTimeList = SmallSampleSimulation$RunTimeList  # in seconds
SmallSampleCoverageList = data.frame(SmallSampleSimulation$CoverageList) 
SmallSampleParameterVector = SmallSampleSimulation$ParameterVector

SmallSampleResultsTable = cbind(SmallSampleSEMedianList[,c(1:5)],
                                SmallSampleCoverageList[,6:9],
                                SmallSampleSEMedianList[,6:10])
rownames(SmallSampleResultsTable) = paste0("Case ", 1:nrow(SmallSampleResultsTable)) 

SmallSampleResultsTable = SmallSampleResultsTable %>% mutate(Misspec. = case_when(Misspec. == 0 ~ "No",
                                                                  Misspec. == 1 ~ "Yes"),
                                             Homo. = case_when(Homo. == 0 ~ "Yes",
                                                               Homo. == 0.5 ~ "No"),
                                             Leverage = case_when(Leverage == 0 ~ "No",
                                                                  Leverage == 0.1 ~ "Yes"))
```

### Large Sample
```{r}
# ### Get Files ###
# file_list = list.files(path =  paste0(dir,"Results/Linear/N500_2000"),
#                         pattern = "\\.rds$",
#                         full.names = TRUE)
# LargeSampleSimulation = list()
# LargeSampleSimulation = lapply(file_list, readRDS)
# rm(file_list)
# 
# ### Results ###
# LargeSampleSimulation = SimulationReformatResultsFunction(LargeSampleSimulation)
# LargeSampleSEMedianList = LargeSampleSimulation$SimSEMedianList
# # LargeSampleMonteCarloResults = MonteCarloResults(LargeSampleSimulation, 5)
# LargeSampleRunTimeList = LargeSampleSimulation$RunTimeList  # in seconds
# LargeSampleCoverageList = data.frame(LargeSampleSimulation$CoverageList) 
# LargeSampleParameterVector = LargeSampleSimulation$ParameterVector
# 
# LargeSampleResultsTable = cbind(LargeSampleSEMedianList[,c(1:5)],
#                                 LargeSampleCoverageList[,6:9],
#                                 LargeSampleSEMedianList[,6:10]) %>%
#   select(-c(Difference,Indicator))
# rownames(LargeSampleResultsTable) = paste0("Case ", 1:nrow(LargeSampleResultsTable)) 
# 
# LargeSampleResultsTable = LargeSampleResultsTable %>% mutate(Misspec. = case_when(Misspec. == 0 ~ "No",
#                                                                   Misspec. == 1 ~ "Yes"),
#                                              Homo. = case_when(Homo. == 0 ~ "Yes",
#                                                                Homo. == 0.5 ~ "No"),
#                                              Leverage = case_when(Leverage == 0 ~ "No",
#                                                                   Leverage == 0.1 ~ "Yes"))
```

# Percentage Change by N
```{r}
### Pivoting ###
SmallSampleSEMedianList %>% 
  select(-c(Population, Conditional, Indicator, Difference)) %>%
  pivot_wider(names_from = SS,
              values_from = PercentChange) %>%
  rename(N.50 = "50",
         N.200 = "200") %>%
  relocate(N.50, .before=N.200) %>% 
  data.frame -> PivotWiderSmallSampleSE

LargeSampleSEMedianList %>% 
  select(-c(Population, Conditional, Indicator, Difference)) %>%
  pivot_wider(names_from = SS,
              values_from = PercentChange) %>%
  rename(N.500 = "500",
         N.2000 = "2000") %>%
  relocate(N.500, .before=N.2000)%>% 
  data.frame -> PivotWiderLargeSampleSE

### Difference Table ###
DifferenceTable = merge(PivotWiderSmallSampleSE, 
                        PivotWiderLargeSampleSE, by = c("Misspec.","Homo.","Leverage","K")) %>%
  relocate(N.500, .after = N.200)

# DifferenceTable = DifferenceTable %>% 
#   mutate(Misspec. = case_when(Misspec. == 0 ~ "No",
#                               Misspec. == 1 ~ "Yes"),
#          Homo. = case_when(Homo. == 0 ~ "Yes",
#                            Homo. == 0.5 ~ "No"),
#          Leverage = case_when(Leverage == 0 ~ "No",
#                               Leverage == 0.1 ~ "Yes"))

ChangeInDifference = DifferenceTable %>% mutate(N.2000 = case_when(abs(N.500)>abs(N.2000) ~ "Smaller", 
                                                                   abs(N.500)<abs(N.2000) ~ "Larger"),
                                                N.500 = case_when(abs(N.200)>abs(N.500) ~ "Smaller", 
                                                                  abs(N.200)<abs(N.500) ~ "Larger"),
                                                N.200 = case_when(abs(N.50)>abs(N.200) ~ "Smaller", 
                                                                  abs(N.50)<abs(N.200) ~ "Larger")) %>%
  select(-c(N.50))

### xtable ###
DifferenceTable %>% xtable(digits = 5, caption = "Percent change in using conditional standard error estimates instead of population standard error estimates by sample size.")
```



# Presentation Xtable
## Small Sample

### Coverage
```{r}
### Correctly Specified Models ###
# SmallSampleResultsTable %>% 
#   select(-c(Population, Conditional, Difference, Indicator, PercentChange)) %>% 
#   filter(Misspec. == "No") %>%
#   xtable(digits = 5,
#          caption = "Simulation coverage rates for 50,000 replications with small samples (correctly specified models)")

### Misspecified Models ###
# SmallSampleResultsTable %>%
#   select(-c(Population, Conditional, Difference, Indicator, PercentChange)) %>%
#   filter(Misspec. == "Yes") %>%
#   xtable(digits = 5,
#          caption = "Simulation coverage rates for 50,000 replications with small samples (misspecified models)")
```
### Percentage Change
```{r}
### Correctly Specified Models ###
# SmallSampleResultsTable %>% 
#   select(-c(ThetaPop_VPop, ThetaPop_VCond, ThetaCond_VPop, ThetaCond_VCond)) %>%
#     filter(Misspec. == "No") %>%
#   xtable(digits = 5,
#          caption = "Simulation results over $50,000$ replications with small samples (correctly specified models)")

### Misspecified Models ###
SmallSampleResultsTable %>%
  select(-c(ThetaPop_VPop, ThetaPop_VCond, ThetaCond_VPop, ThetaCond_VCond)) %>%
    filter(Misspec. == "Yes") %>%
  xtable(digits = 5,
         caption = "Simulation results over $50,000$ replications with small samples (correctly specified models)")

```
### Percentage Change
```{r}

```


## Large Sample
### Coverage
### Percentage Change
```{r}
LargeSampleResultsTable %>% 
  select(-c(ThetaPop_VPop, ThetaPop_VCond, ThetaCond_VPop, ThetaCond_VCond, Difference)) %>%
  mutate(Misspec. = case_when(Misspec. == 0 ~ "No",
                              Misspec. == 1 ~ "Yes"),
         Homo. = case_when(Homo. == 0 ~ "Yes",
                           Homo. == 0.5 ~ "No"),
         Leverage = case_when(Leverage == 0 ~ "No",
                              Leverage == 0.1 ~ "Yes")) %>%
  xtable(digits = 5,
         caption = "Simulation results over $50,000$ replications with small samples (correctly specified models)")

LargeSampleResultsTable %>% 
  select(-c(Population, Conditional, Difference, PercentChange)) %>%
  mutate(Misspec. = case_when(Misspec. == 0 ~ "No",
                              Misspec. == 1 ~ "Yes"),
         Homo. = case_when(Homo. == 0 ~ "Yes",
                           Homo. == 0.5 ~ "No"),
         Leverage = case_when(Leverage == 0 ~ "No",
                              Leverage == 0.1 ~ "Yes")) %>%
  xtable(digits = 5,
         caption = "Simulation results over $50,000$ replications with small samples (correctly specified models)")
```

```{r}
SmallSampleResultsTable %>% filter(SS == 50) %>% select(PercentChange) %>% colMeans
SmallSampleResultsTable %>% filter(SS == 200) %>% select(PercentChange) %>% colMeans
```
