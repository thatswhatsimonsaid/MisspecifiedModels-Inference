---
title: "Stats 572 - Run Simulation Study 1"
author: "Simon Dovan Nguyen"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    theme: lumen
    css: assets/styles.css
---

# Set Up
## Notes
- Did I do the Mahlahnobis distance correctly

## Libr.
```{r message=FALSE, warning=FALSE}
library(stats)
library(tidyverse)
library(StatMatch)
library(xtable)
library(lmtest)
library(sandwich)
library(mixtools)
library(distr)
```

## Rm. Var.
```{r}
rm(list=ls())
dir = "/Users/simondn/Documents/Stats572/"
```

# Functions
```{r}
source(paste0(dir,"Code/AIZResults.R"))
source(paste0(dir,"Code/ConfidenceIntervalFunction.R"))
source(paste0(dir,"Code/OneIterationFunction.R"))
source(paste0(dir,"Code/SimDataLinear.R"))
source(paste0(dir,"Code/SimDataLogistic.R"))
source(paste0(dir,"Code/SimulationFunction.R"))
source(paste0(dir,"Code/SimulationReformatResultsFunction.R"))
source(paste0(dir,"Code/ThetaCondFunction.R"))
source(paste0(dir,"Code/ThetaPopFunction.R"))
source(paste0(dir,"Code/VHatCondFunction.R"))
source(paste0(dir,"Code/VHatPopFunction.R"))
source(paste0(dir,"Code/WhichMinFunction.R"))
```

# Set Up
```{r}
AIZ = AIZResults("Logistic")
### Set Up ###
set.seed(420)
TypeSetting = "Logistic"
ParameterVector = cbind(MisspecVec = c(rep(0,16),rep(1,16)),                        # Delta: Misspecification Rate
                        HomoskedVec = rep(c(rep(0,8), rep(0.5,8)),2),                # Gamma: Heteroskedasticity Rate
                        SizeVec = rep(c(rep(50,4), rep(200,4)),4),                   # N: Observations
                        LeverageVec = rep(c(0,0,0.1,0.1),8),                         # rho: Mixture Leverage
                        KVec = rep(c(1,5),16)                                        # K: Parameters
                        ) %>% data.frame
SimulationCase = 1
VarFixed = NA

### Parameters ###
delta = ParameterVector$MisspecVec[SimulationCase]  
gamma =  ParameterVector$HomoskedVec[SimulationCase]  
N = ParameterVector$SizeVec[SimulationCase]            
rho =  ParameterVector$LeverageVec[SimulationCase]     
K = ParameterVector$KVec[SimulationCase] 
```

# Simulation

### SimDataLogistic
```{r}
### Set Up ###
NSim = 1000
ResultsList = matrix(numeric(nrow(ParameterVector)* 7), ncol =7)
colnames(ResultsList) = c("delta", "gamma", "N", "rho", "K", "VPop", "VCond")

for(SimCase in 1:nrow(ParameterVector)){
  ### Set Up ###
  VPop = numeric(NSim)
  VCond = numeric(NSim)
  
  ### Progress Bar ####
  print(paste0("Case: ",SimCase))
  pb = txtProgressBar(min = 0, 
                        max = NSim,
                        style = 3,  
                        width = 50,
                        char = "=")
  
  ### Parameters ###
  SimulationCase = SimCase
  delta = ParameterVector$MisspecVec[SimulationCase]  
  gamma =  ParameterVector$HomoskedVec[SimulationCase]  
  N = ParameterVector$SizeVec[SimulationCase]            
  rho =  ParameterVector$LeverageVec[SimulationCase]     
  K = ParameterVector$KVec[SimulationCase] 
  
  for(i in 1:NSim){
    # print(i)
    setTxtProgressBar(pb, i)
    
    ### Data Generating Process 
    dat = SimDataLogistic(N, rho, K, delta, gamma)$dat
    
    ### Model ###
    model <- glm(Y ~ ., data = dat, family = binomial(link = "logit"))
    beta_hat = as.numeric(model$coefficients) 
    epsilon_hat = as.numeric(model$residuals)
    
    ### Results ###
    VPop[i] = sqrt(diag(vcovHC(model, type = "HC0")))[2]
    VCond[i] = VHatCondFunction(dat, epsilon_hat, VarFixed = NA)$RegressionSE[2]
  }
  
  ResultsList[SimCase, ] = c(delta=delta, gamma=gamma, N=N, rho=rho, K = K, VPop = mean(VPop), VCond = mean(VCond))

}
ResultsList = data.frame(ResultsList)

```

### Hard Coded ###
```{r}
# ### Set Up ###
# NSim = 1000
# ResultsList = matrix(numeric(nrow(ParameterVector)* 7), ncol =7)
# colnames(ResultsList) = c("delta", "gamma", "N", "rho", "K", "VPop", "VCond")
# 
# 
# for(SimCase in 1:nrow(ParameterVector)){
#   ### Set Up ###
#   VPop = numeric(NSim)
#   VCond = numeric(NSim)
#   
#   ### Progress Bar ####
#   print(paste0("Case: ",SimCase))
#   pb = txtProgressBar(min = 0, 
#                         max = NSim,
#                         style = 3,  
#                         width = 50,
#                         char = "=")
#   
#   ### Parameters ###
#   SimulationCase = SimCase
#   delta = ParameterVector$MisspecVec[SimulationCase]  
#   gamma =  ParameterVector$HomoskedVec[SimulationCase]  
#   N = ParameterVector$SizeVec[SimulationCase]            
#   rho =  ParameterVector$LeverageVec[SimulationCase]     
#   K = ParameterVector$KVec[SimulationCase] 
#   
# ### Simulation ###
# for(i in 1:NSim){
#   
#   ### Set Up ###
#   setTxtProgressBar(pb, i)
#   
#   ### Coefficient Matrix ###
#   if(K == 1){CoefficientVector = matrix(1)}else if(K>1){
#     CoefficientVector = matrix(c(1,rep(0,K-1)))}
#   
#   ### Covariates ###
#   theta_0 = 0
#   X1 = sample(c(rnorm(N*(1-rho), mean = 0, sd = 1),
#                 rlnorm(N*rho, meanlog = 0, sdlog = sqrt(0.5))))
#   X2K = sapply(1:(K-1), function(x) rnorm(n = N, mean = 0, sd = 1))
#   if(K == 1){XMatrix = as.numeric(X1)}else if(K>1){
#     XMatrix = matrix(cbind(X1, X2K), ncol = K)}
#   
#   ### Data Generating Process ###
#   
#   ## Gamma ##
#   epsilon_star_i <- rlogis(N, location = 0, scale = 1)  # Logistic distribution for errors
#   
#   ### Heteroskedasticity Gamma ###
#   if(gamma == 0){
#     epsilon_i = epsilon_star_i
#   }else if(gamma !=0){
#     epsilon_i = epsilon_star_i*exp(1-gamma*X1)
#   }
#   
#   ### Model Misspecification Delta ###
#   if(delta == 0){
#     Ystar = rep(0,N) + XMatrix %*% CoefficientVector + epsilon_i
#     }else if(delta !=0){
#     Ystar = X1 + (X1^2 - 1) + epsilon_i
#     }
#   
#   ## Outcome ##
#   Y <- as.numeric(Y_star >= 0)
#   dat = data.frame(Y, XMatrix)
#   colnames(dat) = c("Y",paste0("X", 1:K))
#   
#   ### Model ###
#   model <- glm(Y ~ ., data = dat, family = binomial(link = "logit"))
#   beta_hat = as.numeric(model$coefficients) 
#   epsilon_hat = as.numeric(model$residuals)
#   
#   ### Results ###
#   VPop[i] = sqrt(diag(vcovHC(model, type = "HC0")))[2]
#   VCond[i] = VHatCondFunction(dat, epsilon_hat, VarFixed = NA)$RegressionSE[2]
# }
#   ResultsList[SimCase, ] = c(delta=delta, gamma=gamma, N=N, rho=rho, K = K, VPop = mean(VPop), VCond = mean(VCond))
# }
# ResultsList = data.frame(ResultsList)
```




